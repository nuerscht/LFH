@(productForm: Form[models.Product], title: String, message: String)

@import helper._
@import helper.twitterBootstrap._

@attributeGroup(field: Field, className: String = "attribute") = {
    <div class="well @className">
        <a class="removeAttribute btn danger pull-right">Remove this attribute</a>
        @inputText(
            field("value"), 
            '_label -> "Wert"
        )
    </div>
}

@main("LFH Shop - Produckt hinzufuegen") {

    @form(action = routes.Product.save(1), 'id -> "form") {
        @if(!message.isEmpty()) {
            <div class="alert">
                <a class="close" data-dismiss="alert">x</a> 
                <strong>Meldung: </strong>@message.  
            </div>
        }
            
        <h1>@title</h1>
        @inputText(productForm("title"), 
                   '_label -> "Produkt Name", 
                   'class -> "form-control", 
                   'placeholder -> "Bitte Namen eingeben", 
                   'required -> "required", 
                   'type -> "text", 
                   'maxlength -> "45",
                   '_help -> ""
                   )

        @inputText(productForm("ean"), 
                   '_label -> "EAN", 
                   'class -> "form-control", 
                   'placeholder -> "Bitte EAN eingeben", 
                   'required -> "required", 
                   'type -> "text", 
                   'maxlength -> "13",
                   '_help -> ""
                   )
                   
        @inputText(productForm("price"), 
                   '_label -> "Preis", 
                   'class -> "form-control", 
                   'placeholder -> "Bitt Preis eingeben", 
                   'required -> "required", 
                   'type -> "text", 
                   'maxlength -> "45",
                   '_help -> ""
                   )

        @textarea(productForm("description"), 
                   '_label -> "Beschreibung",
                   'class -> "form-control description", 
                   'placeholder -> "Bitte Beschreibung eingeben", 
                   'required -> "required",
                   'height -> "200"
            )

        <div class="attributes">
            @repeat(productForm("attributes"), min = 1) { attributeField =>
                @attributeGroup(attributeField)
            }
            @**
            * Keep an hidden block that will be used as template for Javascript copy code
            **@
            @attributeGroup(
                productForm("attributes[x]"),
                className = "attribute_template"
            )
            <div class="manage">
                    <a class="addAttribute btn success">Neues Attribut</a>
            </div>
    
        </div>
        
    <button type="submit" id="save-product" class="btn btn-default">Speichern</button>
    }
    
    <script type="text/javascript" charset="utf-8">
        
        $('.removeAttribute').live('click', function(e) {
            $(this).parents('.attribute').remove()
            renumber()
        })
        
        $('.addAttribute').live('click', function(e) {
            var template = $('.attribute_template')
            template.before('<div class="well attribute">' + template.html() + '</div>')
            renumber()
        })
        
        $('#form').submit(function() {
            $('.attribute_template').remove()
        })
        
        // -- renumber fields
        
        // Rename fields to have a coherent payload like:
        //
        // attributes[0].label
        // attributes[0].email
        // ...
        //
        // This is probably not the easiest way to do it. A jQuery plugin would help.
        
        var renumber = function(phones) {
            $('.attribute').each(function(i) {
                $('input', this).each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/attributes\[.+?\]/g, 'attributes[' + i + ']'))
                })
            })
        }
        
    </script>
}