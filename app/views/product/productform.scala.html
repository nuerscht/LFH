@(productForm: Form[models.Product], productId: Integer, title: String, message: String)

@import helper._
@import helper.twitterBootstrap._

@attributeGroup(field: Field, className: String = "attribute") = {
    <div class="@className">
        
        <a class="removeAttribute pull-right"><img src="@routes.Assets.at("images/delete.png")"></a>
        
        @inputText(
            field("value"), 
            '_label -> "Wert",
            'class -> "form-control" 
        )
    </div>
}

@imageGroup(field: Field, className: String = "image") = {
    <div class="@className">
        
        <a class="removeImage pull-right"><img src="@routes.Assets.at("images/delete.png")"></a>
        
        @inputText(
            field("name"), 
            '_label -> "Name",
            'class -> "form-control" 
        )
        
        @inputText(
            field("description"),
            '_label -> "Beschreibung",
            'class -> "form-control" 
        )
        
        @if(field("name").value.isEmpty){
            <input type="file">
        }else{
            <div>
                @routes.Assets.at("images/upload/" + field("id").value.get + field("extension").value.get)
                <img src="@routes.Assets.at("images/upload/" + field("id").value.get + field("extension").value.get)">
            </div>
        }
    </div>
}

@main("LFH Shop - Produckt hinzufuegen") {

    @form(action = routes.Product.save(productId), 'id -> "form", 'enctype -> "multipart/form-data") {
        @if(!message.isEmpty()) {
            <div class="alert">
                <a class="close" data-dismiss="alert">x</a>
                <strong>Meldung:</strong> @message.
            </div>
        }
            
        <h1>@title</h1>
        @inputText(productForm("title"), 
                   '_label -> "Produkt Name", 
                   'class -> "form-control", 
                   'placeholder -> "Bitte Namen eingeben", 
                   'required -> "required", 
                   'type -> "text", 
                   'maxlength -> "45",
                   '_help -> ""
                   )

        @inputText(productForm("ean"), 
                   '_label -> "EAN", 
                   'class -> "form-control", 
                   'placeholder -> "Bitte EAN eingeben", 
                   'required -> "required", 
                   'type -> "text", 
                   'maxlength -> "13",
                   '_help -> ""
                   )
                   
        @inputText(productForm("price"), 
                   '_label -> "Preis", 
                   'class -> "form-control", 
                   'placeholder -> "Bitt Preis eingeben", 
                   'required -> "required", 
                   'type -> "text", 
                   'maxlength -> "45",
                   '_help -> ""
                   )

        @textarea(productForm("description"), 
                   '_label -> "Beschreibung",
                   'class -> "form-control description", 
                   'placeholder -> "Bitte Beschreibung eingeben", 
                   'required -> "required",
                   'height -> "200"
            )

        <div class="attributes">
        
            <h2>Attribute</h2>
        
            @repeat(productForm("attributes"), min = 1) { attributeField =>
                @attributeGroup(attributeField)
            }
            @**
            * Keep an hidden block that will be used as template for Javascript copy code
            **@
            @attributeGroup(
                productForm("attributes[x]"),
                className = "attribute_template"
            )
            <div class="manage">
                <a class="addAttribute btn btn-default">Neues Attribut</a>
            </div>
    
        </div>
        
        <div class="images">
        
            <h2>Bilder</h2>
        
            @repeat(productForm("images"), min = 1) { imageField =>
                @imageGroup(imageField)
            }
            @**
            * Keep an hidden block that will be used as template for Javascript copy code
            **@
            @imageGroup(
                productForm("images[x]"),
                className = "image_template"
            )
            <div class="manage">
                <a class="addImage btn btn-default">Neues Bild</a>
            </div>
    
        </div>
        
    <button type="submit" id="save-product" class="btn btn-primary">Speichern</button>
    }
    
    <script type="text/javascript" charset="utf-8">
        
        $('.attributes').on('click', 'a', function(e) {
            $(this).parents('.attribute').remove()
            renumber()
        })
        
        $('.addAttribute').on('click', function(e) {
            var template = $('.attribute_template')
            template.before('<div class="attribute">' + template.html() + '</div>')
            renumber()
            cleanLabel()
        })
        
        $('.images').on('click', 'a', function(e) {
            $(this).parents('.image').remove()
            renumber()
        })
        
        $('.addImage').on('click', function(e) {
            var template = $('.image_template')
            template.before('<div class="image">' + template.html() + '</div>')
            renumber()
        })
        
        $('#form').submit(function() {
            $('.attribute_template').remove()
            $('.image_template').remove()
        })
        
        $(document).ready(function() {
        	cleanLabel()
        })
        
        // Pretty nasty, but did not manage to create working inputs without lables
        var cleanLabel = function(){
        	$('label:contains("Wert")').remove()
        	$('span:contains("Required")').remove()
        }
        
        // -- renumber fields
        
        // Rename fields to have a coherent payload like:
        //
        // attributes[0].value
        // ...
        //
        // This is probably not the easiest way to do it. A jQuery plugin would help.
        
        var renumber = function() {
        	alert("Trying")
            $('.attribute').each(function(i) {
                $('input', this).each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/attributes\[.+?\]/g, 'attributes[' + i + ']'))
                })
            })
            alert("Here!")
            $('.image').each(function(i) {
                $('input', this).each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/images\[.+?\]/g, 'images[' + i + ']'))
                    alert(i)
                })
            })
            alert("Did it!")
        }
        
    </script>
}